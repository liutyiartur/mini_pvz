<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>PvZ Mini</title>
    <style>
        body {
            margin: 0;
            background: #8b5a2b;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial;
        }

        #game {
            position: relative;
            width: 720px;
            height: 360px;
            border: 4px solid #2f6f2f;
        }

        canvas {
            display: block;
        }

        #playBtn {
            position: absolute;
            left: 50%;
            top: 55%;
            transform: translate(-50%, -50%);
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
        }

        #result {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
        }
    </style>
</head>

<body>
<div id="game">
    <canvas id="c" width="720" height="360"></canvas>
    <button id="playBtn">ИГРАТЬ</button>
    <div id="result"></div>
</div>

<script>
    const c = document.getElementById("c"), ctx = c.getContext("2d");
    const playBtn = document.getElementById("playBtn");

    const rows = 3, cols = 7;
    const cw = c.width / cols, ch = c.height / rows;

    let mode = "menu";
    let plants = [], zombies = [], bullets = [];
    let wave = 0, spawned = 0, tick = 0;
    let gameOver = false;

    playBtn.onclick = () => {
        mode = "game";
        playBtn.style.display = "none";
        startWave();
    };

    function startWave() {
        wave++;
        spawned = 0;
    }

    function spawnZombie() {
        let type = "normal", hp = 6;
        if (wave >= 2 && Math.random() < 0.5) {
            type = "cone";
            hp = 12;
        }
        if (wave >= 3 && Math.random() < 0.3) {
            type = "bucket";
            hp = 20;
        }
        zombies.push({x: c.width + 30, row: Math.floor(Math.random() * rows), hp, type, eat: false, target: null});
        spawned++;
    }

    function update() {
        if (mode !== "game" || gameOver) return;
        tick++;

        if (spawned < wave * 3 && tick % 120 === 0) spawnZombie();
        if (spawned >= wave * 3 && zombies.length === 0) {
            if (wave === 3) {
                gameOver = true;
                document.getElementById("result").innerText = "Ты выиграл!";
                document.getElementById("result").style.color = "green";
            } else startWave();
        }

        zombies.forEach(z => {
            if (z.eat && z.target) {
                z.target.hp -= 0.04;
                if (z.target.hp <= 0) {
                    plants.splice(plants.indexOf(z.target), 1);
                    z.eat = false;
                    z.target = null;
                }
            } else {
                z.x -= 0.3;
                plants.forEach(p => {
                    const px = p.col * cw + cw / 2;
                    if (p.row === z.row && Math.abs(z.x - px) < 18) {
                        z.eat = true;
                        z.target = p;
                    }
                });
            }
            if (z.x < 0) {
                gameOver = true;
                document.getElementById("result").innerText = "Ты проиграл!";
                document.getElementById("result").style.color = "red";
            }
        });
    }

    function drawZombie(z) {
        const y = z.row * ch + ch / 2;
        ctx.fillStyle = "#4caf50";
        ctx.beginPath();
        ctx.arc(z.x, y, 18, 0, Math.PI * 2);
        ctx.fill();

        // глаз
        ctx.fillStyle = "white";
        ctx.beginPath();
        ctx.arc(z.x + 6, y - 4, 4, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = "black";
        ctx.beginPath();
        ctx.arc(z.x + 7, y - 4, 2, 0, Math.PI * 2);
        ctx.fill();

        // рот
        ctx.strokeStyle = "black";
        ctx.beginPath();
        ctx.moveTo(z.x - 6, y + 6);
        ctx.lineTo(z.x + 6, y + 6);
        ctx.stroke();

        // защита
        if (z.type === "cone") {
            ctx.fillStyle = "orange";
            ctx.beginPath();
            ctx.moveTo(z.x, y - 28);
            ctx.lineTo(z.x - 12, y - 4);
            ctx.lineTo(z.x + 12, y - 4);
            ctx.fill();
        }
        if (z.type === "bucket") {
            ctx.fillStyle = "gray";
            ctx.fillRect(z.x - 14, y - 30, 28, 18);
        }
    }

    function drawMenu() {
        // небо
        ctx.fillStyle = "#87ceeb";
        ctx.fillRect(0, 0, c.width, c.height * 0.6);

        // трава
        ctx.fillStyle = "#4caf50";
        ctx.fillRect(0, c.height * 0.6, c.width, c.height * 0.4);

        // надгробье
        ctx.fillStyle = "#9e9e9e";
        ctx.fillRect(420, 120, 120, 160);
        ctx.beginPath();
        ctx.arc(480, 120, 60, Math.PI, 0);
        ctx.fill();
    }

    function drawGame() {
        ctx.fillStyle = "#7ec850";
        ctx.fillRect(0, 0, c.width, c.height);

        ctx.strokeStyle = "#5fa35f";
        for (let i = 0; i <= rows; i++) {
            ctx.beginPath();
            ctx.moveTo(0, i * ch);
            ctx.lineTo(c.width, i * ch);
            ctx.stroke();
        }
        for (let i = 0; i <= cols; i++) {
            ctx.beginPath();
            ctx.moveTo(i * cw, 0);
            ctx.lineTo(i * cw, c.height);
            ctx.stroke();
        }

        zombies.forEach(drawZombie);
    }

    function draw() {
        ctx.clearRect(0, 0, c.width, c.height);
        if (mode === "menu") drawMenu();
        else drawGame();
    }

    (function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
    })();
</script>
</body>
</html>
