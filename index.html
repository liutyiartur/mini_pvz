<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Mini PvZ Full</title>
    <style>
        body {
            background: linear-gradient(#87ceeb, #e6f3e6);
            font-family: Arial;
            display: flex;
            justify-content: center;
        }

        #game {
            text-align: center;
            margin-top: 10px
        }

        canvas {
            background: #7ec850;
            border: 4px solid #2f6f2f;
        }

        button {
            margin: 3px;
            padding: 6px 10px
        }

        #panel {
            margin-bottom: 5px;
        }

        button.active {
            background: #ccc;
        }
    </style>
</head>
<body>
<div id="game">
    <div id="panel">
        <button onclick="selectPlant('pea')">üå± –ì–æ—Ä–æ—Ö (50)</button>
        <button onclick="selectPlant('sun')">üåª –ü–æ–¥—Å–æ–ª–Ω—É—Ö (25)</button>
        <button onclick="selectPlant('nut')">ü•ú –û—Ä–µ—Ö (25)</button>
        <button id="shovelBtn" onclick="selectShovel()">ü™ì –õ–æ–ø–∞—Ç–∞</button>
    </div>
    <canvas id="c" width="720" height="360"></canvas>
    <br>
    <div id="sun">–°–æ–ª–Ω—Ü–∞: 100</div>
    <div id="status"></div>
</div>

<script>
    const c = document.getElementById("c"), ctx = c.getContext("2d");
    const rows = 3, cols = 7, cellW = c.width / cols, cellH = c.height / rows;
    let sun = 100, plants = [], zombies = [], bullets = [], suns = [], lawnmowers = [];
    let selectedPlant = null, shovel = false, tick = 0;

    // –õ–æ–ø–∞—Ç–∞
    const shovelBtn = document.getElementById("shovelBtn");

    // –ì–∞–∑–æ–Ω–æ–∫–æ—Å–∏–ª–∫–∏
    for (let r = 0; r < rows; r++) lawnmowers.push({row: r, x: -20, active: true});

    // –í—ã–±–æ—Ä —Ä–∞—Å—Ç–µ–Ω–∏–π
    function selectPlant(type) {
        selectedPlant = type;
        shovel = false;
        shovelBtn.classList.remove("active");
    }

    function selectShovel() {
        shovel = true;
        selectedPlant = null;
        shovelBtn.classList.add("active");
    }

    // –ö–ª–∏–∫ –ø–æ canvas
    c.onclick = e => {
        const rect = c.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const col = Math.floor(x / cellW);
        const row = Math.floor(y / cellH);

        // —Å–æ–±—Ä–∞—Ç—å —Å–æ–ª–Ω—Ü–µ
        suns.forEach((s, i) => {
            if (Math.hypot(s.x - x, s.y - y) < 15) {
                sun += 25;
                suns.splice(i, 1);
            }
        });

        if (shovel) {
            const i = plants.findIndex(p => p.row === row && p.col === col);
            if (i != -1) plants.splice(i, 1);
            shovel = false;
            shovelBtn.classList.remove("active");
            return;
        }

        if (!selectedPlant) return;
        if (plants.some(p => p.row === row && p.col === col)) return;
        const cost = {pea: 50, sun: 25, nut: 25}[selectedPlant];
        if (sun < cost) return;
        plants.push({row, col, type: selectedPlant, hp: selectedPlant === "nut" ? 20 : 3, cd: 0, scd: 300});
        sun -= cost;
        selectedPlant = null;
    }

    // –ó–æ–º–±–∏
    function spawnZombie() {
        let ztype = "normal";
        let rand = Math.random();
        if (rand < 0.3) ztype = "cone";
        else if (rand < 0.5) ztype = "bucket";
        let hp = ztype === "bucket" ? 30 : ztype === "cone" ? 18 : 10;
        zombies.push({
            row: Math.floor(Math.random() * rows),
            x: c.width - 20,
            hp,
            type: ztype,
            eat: false,
            target: null
        });
    }

    // –°–æ–ª–Ω—Ü–µ
    function spawnSun() {
        suns.push({x: Math.random() * c.width, y: -20});
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    function update() {
        tick++;
        if (tick % 200 === 0) spawnZombie();
        if (tick % 300 === 0) spawnSun();

        // –†–∞—Å—Ç–µ–Ω–∏—è
        plants.forEach(p => {
            if (p.type === "sun") {
                if (--p.scd <= 0) {
                    suns.push({x: p.col * cellW + cellW / 2, y: p.row * cellH});
                    p.scd = 300;
                }
            }
            if (p.type === "pea" && --p.cd <= 0 && zombies.some(z => z.row === p.row)) {
                bullets.push({x: p.col * cellW + cellW * .7, row: p.row});
                p.cd = 45;
            }
        });

        // –ü—É–ª–∏
        bullets.forEach(b => b.x += 5);

        // –°–æ–ª–Ω—Ü–µ –ø–∞–¥–∞–µ—Ç
        suns.forEach(s => s.y += 0.6);

        // –ó–æ–º–±–∏
        zombies.forEach(z => {
            if (z.eat && z.target) {
                z.target.hp -= 0.03;
                if (z.target.hp <= 0) {
                    plants.splice(plants.indexOf(z.target), 1);
                    z.eat = false;
                    z.target = null;
                }
            } else {
                z.x -= 0.4;
                plants.forEach(p => {
                    const px = p.col * cellW + cellW / 2;
                    if (p.row === z.row && Math.abs(z.x - px) < 18) {
                        z.eat = true;
                        z.target = p;
                    }
                });
                if (z.x <= 0 && lawnmowers[z.row].active) {
                    zombies = zombies.filter(zz => zz.row !== z.row);
                    lawnmowers[z.row].active = false;
                }
            }
        });

        // –ü—É–ª–∏ –±—å—é—Ç –∑–æ–º–±–∏
        bullets.forEach((b, i) => zombies.forEach(z => {
            if (z.row === b.row && Math.abs(z.x - b.x) < 14) {
                z.hp--;
                bullets.splice(i, 1);
            }
        }));
        zombies = zombies.filter(z => z.hp > 0);

        // –ü–æ—Ä–∞–∂–µ–Ω–∏–µ
        if (zombies.some(z => z.x <= 0 && !lawnmowers[z.row].active)) {
            document.getElementById("status").innerText = "üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ";
        }
    }

    // –†–∏—Å–æ–≤–∞–Ω–∏–µ
    function draw() {
        ctx.clearRect(0, 0, c.width, c.height);

        // –°–µ—Ç–∫–∞
        ctx.strokeStyle = "#5fa35f";
        for (let i = 0; i <= rows; i++) {
            ctx.beginPath();
            ctx.moveTo(0, i * cellH);
            ctx.lineTo(c.width, i * cellH);
            ctx.stroke();
        }
        for (let i = 0; i <= cols; i++) {
            ctx.beginPath();
            ctx.moveTo(i * cellW, 0);
            ctx.lineTo(i * cellW, c.height);
            ctx.stroke();
        }

        // –†–∞—Å—Ç–µ–Ω–∏—è
        plants.forEach(p => {
            const cx = p.col * cellW + cellW / 2;
            const cy = p.row * cellH + cellH / 2;
            if (p.type === "pea") {
                ctx.fillStyle = "#2f7d2f";
                ctx.beginPath();
                ctx.arc(cx, cy, 14, 0, Math.PI * 2);
                ctx.fill();
            }
            if (p.type === "sun") {
                ctx.fillStyle = "#ffd93b";
                ctx.beginPath();
                ctx.arc(cx, cy, 20, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = "#a86b00";
                ctx.beginPath();
                ctx.arc(cx, cy, 10, 0, Math.PI * 2);
                ctx.fill();
            }
            if (p.type === "nut") {
                ctx.fillStyle = "#8b5a2b";
                ctx.fillRect(cx - 16, cy - 16, 32, 32);
            }
        });

        // –ó–æ–º–±–∏
        zombies.forEach(z => {
            const zy = z.row * cellH + cellH / 2;
            ctx.fillStyle = "#4f6f2f";
            ctx.beginPath();
            ctx.arc(z.x, zy, 18, 0, Math.PI * 2);
            ctx.fill();
            // –≥–ª–∞–∑–∞
            ctx.fillStyle = "white";
            ctx.beginPath();
            ctx.arc(z.x + 5, zy - 4, 5, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = "black";
            ctx.beginPath();
            ctx.arc(z.x + 6, zy - 4, 2, 0, Math.PI * 2);
            ctx.fill();
            // —Ä–æ—Ç
            ctx.fillStyle = "black";
            ctx.fillRect(z.x - 8, zy + 8, 16, 4);
            // –∫–æ–Ω—É—Å –∏–ª–∏ –≤–µ–¥—Ä–æ
            if (z.type === "cone") {
                ctx.fillStyle = "orange";
                ctx.beginPath();
                ctx.moveTo(z.x - 15, zy - 18);
                ctx.lineTo(z.x + 15, zy - 18);
                ctx.lineTo(z.x, zy - 35);
                ctx.closePath();
                ctx.fill();
            }
            if (z.type === "bucket") {
                ctx.fillStyle = "gray";
                ctx.fillRect(z.x - 15, zy - 35, 30, 18);
            }
        });

        // –ü—É–ª–∏
        bullets.forEach(b => {
            ctx.fillStyle = "yellow";
            ctx.beginPath();
            ctx.arc(b.x, b.row * cellH + cellH / 2, 4, 0, Math.PI * 2);
            ctx.fill();
        });
        // –°–æ–ª–Ω—Ü–µ
        suns.forEach(s => {
            ctx.fillStyle = "orange";
            ctx.beginPath();
            ctx.arc(s.x, s.y, 12, 0, Math.PI * 2);
            ctx.fill();
        });

        document.getElementById("sun").innerText = "–°–æ–ª–Ω—Ü–∞: " + sun;
    }

    (function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
    })();
</script>
</body>
</html>
