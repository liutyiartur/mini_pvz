<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>üß† Mini PvZ<</title>
    <style>
        body {
            background: linear-gradient(#87ceeb, #e6f3e6);
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center
        }

        #game {
            text-align: center;
            margin-top: 20px
        }

        canvas {
            background: #7ec850;
            border: 4px solid #2f6f2f
        }

        button {
            margin: 3px;
            padding: 6px 10px
        }
    </style>
</head>
<body>
<div id="game">
    <canvas id="c" width="720" height="360"></canvas>
    <br>
    <button onclick="select('pea')">üå± –ì–æ—Ä–æ—Ö (50)</button>
    <button onclick="select('sun')">üåª –ü–æ–¥—Å–æ–ª–Ω—É—Ö (25)</button>
    <button onclick="select('nut')">ü•ú –û—Ä–µ—Ö (25)</button>
    <div id="sun">–°–æ–ª–Ω—Ü–∞: 100</div>
    <div id="status"></div>
</div>

<script>
    const c = document.getElementById("c"), ctx = c.getContext("2d");
    const rows = 3, cols = 7, cellW = c.width / cols, cellH = c.height / rows;
    let sun = 100, plants = [], zombies = [], bullets = [], suns = [];
    let selectType = null, tick = 0, spawned = 0, gameOver = false;
    const MAX_Z = 15;

    const PLANTS = {
        pea: {cost: 50, hp: 3, shoot: true},
        sun: {cost: 25, hp: 3, shoot: false, produce: true},
        nut: {cost: 25, hp: 22, shoot: false}
    };

    function select(t) {
        selectType = t;
    }

    c.onclick = e => {
        const r = c.getBoundingClientRect(), x = e.clientX - r.left, y = e.clientY - r.top;
        suns.forEach((s, i) => Math.hypot(s.x - x, s.y - y) < 15 && (sun += 25, suns.splice(i, 1)));
        if (!selectType) return;
        const col = x / cellW | 0, row = y / cellH | 0;
        if (plants.some(p => p.row === row && p.col === col)) return;
        const p = PLANTS[selectType];
        if (sun < p.cost) return;
        plants.push({row, col, type: selectType, hp: p.hp, cd: 0, scd: 300});
        sun -= p.cost;
        selectType = null;
    };

    function spawnZombie() {
        const r = Math.random();
        let hp = 9, type = "normal";
        if (r > .7) {
            hp = 30;
            type = "bucket";
        } else if (r > .4) {
            hp = 18;
            type = "cone";
        }
        zombies.push({row: Math.random() * rows | 0, x: c.width - 20, hp, type, eat: false, t: null});
        spawned++;
    }

    function spawnSun() {
        suns.push({x: Math.random() * c.width, y: -20});
    }

    function update() {
        if (gameOver) return;
        tick++;
        if (tick % 160 == 0 && spawned < MAX_Z) spawnZombie();
        if (tick % 200 == 0) spawnSun();

        plants.forEach(p => {
            if (p.type === "sun" && --p.scd <= 0) {
                suns.push({x: p.col * cellW + cellW / 2, y: p.row * cellH});
                p.scd = 300;
            }
            if (p.type === "pea" && --p.cd <= 0 && zombies.some(z => z.row === p.row)) {
                bullets.push({x: p.col * cellW + cellW * .7, row: p.row});
                p.cd = 45;
            }
        });

        bullets.forEach(b => b.x += 5);
        suns.forEach(s => s.y += .6);

        zombies.forEach(z => {
            if (z.eat && z.t) {
                z.t.hp -= .03;
                if (z.t.hp <= 0) {
                    plants.splice(plants.indexOf(z.t), 1);
                    z.eat = false;
                    z.t = null;
                }
            } else {
                z.x -= .45;
                plants.forEach(p => {
                    const px = p.col * cellW + cellW / 2;
                    if (p.row === z.row && Math.abs(z.x - px) < 18) {
                        z.eat = true;
                        z.t = p;
                    }
                });
            }
        });

        bullets.forEach((b, i) => zombies.forEach(z => {
            if (z.row === b.row && Math.abs(z.x - b.x) < 14) {
                z.hp--;
                bullets.splice(i, 1);
            }
        }));

        zombies = zombies.filter(z => z.hp > 0 && z.x > 0);
        if (zombies.some(z => z.x <= 0)) {
            gameOver = true;
            status.innerText = "üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ";
        }
        if (spawned === MAX_Z && zombies.length === 0) {
            gameOver = true;
            status.innerText = "üéâ –ü–æ–±–µ–¥–∞";
        }
    }

    function draw() {
        ctx.clearRect(0, 0, c.width, c.height);
        ctx.strokeStyle = "#5fa35f";
        for (let i = 0; i <= rows; i++) {
            ctx.beginPath();
            ctx.moveTo(0, i * cellH);
            ctx.lineTo(c.width, i * cellH);
            ctx.stroke();
        }
        for (let i = 0; i <= cols; i++) {
            ctx.beginPath();
            ctx.moveTo(i * cellW, 0);
            ctx.lineTo(i * cellW, c.height);
            ctx.stroke();
        }

        plants.forEach(p => {
            ctx.fillStyle = p.type === "pea" ? "#2f7d2f" : p.type === "sun" ? "#f5c542" : "#8b5a2b";
            ctx.beginPath();
            ctx.arc(p.col * cellW + cellW / 2, p.row * cellH + cellH / 2, 14, 0, 7);
            ctx.fill();
        });

        zombies.forEach(z => {
            ctx.fillStyle = z.type === "bucket" ? "#444" : z.type === "cone" ? "orange" : "#777";
            ctx.beginPath();
            ctx.arc(z.x, z.row * cellH + cellH / 2, 16, 0, 7);
            ctx.fill();
        });

        bullets.forEach(b => {
            ctx.fillStyle = "yellow";
            ctx.beginPath();
            ctx.arc(b.x, b.row * cellH + cellH / 2, 4, 0, 7);
            ctx.fill();
        });

        suns.forEach(s => {
            ctx.fillStyle = "orange";
            ctx.beginPath();
            ctx.arc(s.x, s.y, 12, 0, 7);
            ctx.fill();
        });

        sunDiv.innerText = "–°–æ–ª–Ω—Ü–∞: " + sun;
    }

    const sunDiv = document.getElementById("sun"), status = document.getElementById("status");
    (function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
    })();
</script>
</body>
</html>
