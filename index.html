<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Mini PvZ</title>
    <style>
        body {
            margin: 0;
            background: #8b5a2b;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial;
        }

        #game {
            width: 720px;
            height: 360px;
            border: 4px solid #2f6f2f;
            position: relative;
            overflow: hidden;
            background: #7ec850;
        }

        #sky {
            position: absolute;
            top: 0;
            width: 100%;
            height: 50%;
            background: #87ceeb;
        }

        #grass {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 50%;
            background: #7ec850;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            display: none;
        }

        #menu {
            position: absolute;
            left: 65%;
            top: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .tombstone {
            width: 240px;
            height: 280px;
            background: #888;
            border-radius: 50% 50% 10% 10%;
            position: relative;
        }

        #menu button {
            position: absolute;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 10px 25px;
            font-size: 18px;
            cursor: pointer;
        }

        #panel {
            display: none;
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 5;
        }

        #sun, #result {
            position: absolute;
            right: 10px;
            top: 10px;
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
        }

        #result {
            bottom: 10px;
            top: auto;
            width: 100%;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
        }

        button.active {
            background: #ffb703;
        }
    </style>
</head>

<body>
<div id="game">
    <div id="sky"></div>
    <div id="grass"></div>

    <div id="menu">
        <div class="tombstone"></div>
        <button onclick="startGame()">–ò–≥—Ä–∞—Ç—å</button>
    </div>

    <div id="panel">
        <button onclick="selectPlant('pea')">üå± –ì–æ—Ä–æ—Ö (50)</button>
        <button onclick="selectPlant('sun')">üåª –ü–æ–¥—Å–æ–ª–Ω—É—Ö (25)</button>
        <button onclick="selectPlant('nut')">ü•ú –û—Ä–µ—Ö (25)</button>
        <button id="shovelBtn" onclick="selectShovel()">ü™ì –õ–æ–ø–∞—Ç–∞</button>
    </div>

    <canvas id="c" width="720" height="360"></canvas>
    <div id="sun">–°–æ–ª–Ω—Ü–∞: 100</div>
    <div id="result"></div>

    <!-- PvZ –ó–í–£–ö–ò (myinstants, –ø—Ä—è–º—ã–µ mp3) -->
    <audio id="plantSound" src="https://www.myinstants.com/media/sounds/pvz-plant.mp3"></audio>
    <audio id="sunSound" src="https://www.myinstants.com/media/sounds/pvz-sun.mp3"></audio>
    <audio id="shootSound" src="https://www.myinstants.com/media/sounds/pvz-pea-shoot.mp3"></audio>
    <audio id="spawnSound" src="https://www.myinstants.com/media/sounds/pvz-groan.mp3"></audio>
    <audio id="eatSound" src="https://www.myinstants.com/media/sounds/pvz-chomp.mp3"></audio>
    <audio id="deathSound" src="https://www.myinstants.com/media/sounds/pvz-zombie-death.mp3"></audio>
    <audio id="winSound" src="https://www.myinstants.com/media/sounds/pvz-win.mp3"></audio>
    <audio id="loseSound" src="https://www.myinstants.com/media/sounds/pvz-lose.mp3"></audio>
</div>

<script>
    const c = document.getElementById("c"), ctx = c.getContext("2d");
    const rows = 3, cols = 7, cw = c.width / cols, ch = c.height / rows;

    let sun = 100, plants = [], zombies = [], bullets = [], suns = [];
    let selected = null, shovel = false, game = false, over = false;
    let tick = 0, wave = 1, spawned = 0, audioUnlocked = false;

    const A = {
        plant: plantSound, sun: sunSound, shoot: shootSound,
        spawn: spawnSound, eat: eatSound, death: deathSound,
        win: winSound, lose: loseSound
    };

    function play(a) {
        A[a].cloneNode().play();
    }

    function unlockAudio() {
        if (audioUnlocked) return;
        audioUnlocked = true;
        document.querySelectorAll("audio").forEach(a => {
            a.volume = 0;
            a.play().then(() => {
                a.pause();
                a.currentTime = 0;
                a.volume = 1;
            });
        });
    }

    function startGame() {
        unlockAudio();
        document.getElementById("menu").style.display = "none";
        document.getElementById("panel").style.display = "block";
        c.style.display = "block";
        game = true;
    }

    function selectPlant(t) {
        selected = t;
        shovel = false;
    }

    function selectShovel() {
        shovel = true;
        selected = null;
    }

    c.onclick = e => {
        if (!game) return;
        const r = c.getBoundingClientRect();
        const x = e.clientX - r.left, y = e.clientY - r.top;
        const col = Math.floor(x / cw), row = Math.floor(y / ch);

        suns.forEach((s, i) => {
            if (Math.hypot(s.x - x, s.y - y) < 15) {
                sun += 25;
                suns.splice(i, 1);
                play("sun");
            }
        });

        if (shovel) {
            const i = plants.findIndex(p => p.row === row && p.col === col);
            if (i != -1) plants.splice(i, 1);
            shovel = false;
            return;
        }

        if (!selected) return;
        if (plants.some(p => p.row === row && p.col === col)) return;

        const cost = {pea: 50, sun: 25, nut: 25}[selected];
        if (sun < cost) return;

        plants.push({row, col, type: selected, hp: selected === "nut" ? 20 : 5, cd: 0});
        sun -= cost;
        play("plant");
    }

    function spawnZombie() {
        play("spawn");
        let t = "normal", hp = 8;
        if (wave >= 2 && Math.random() < 0.4) {
            t = "cone";
            hp = 16;
        }
        if (wave >= 3 && Math.random() < 0.3) {
            t = "bucket";
            hp = 28;
        }
        zombies.push({row: Math.floor(Math.random() * rows), x: c.width + 20, hp, type: t, eat: false});
        spawned++;
    }

    function update() {
        if (!game || over) return;
        tick++;

        if (tick % 180 === 0 && spawned < wave * 4) spawnZombie();
        if (tick % 300 === 0) suns.push({x: Math.random() * c.width, y: -10});

        plants.forEach(p => {
            if (p.type === "sun" && tick % 300 === 0)
                suns.push({x: p.col * cw + cw / 2, y: p.row * ch + ch / 2});
            if (p.type === "pea" && tick % 60 === 0 && zombies.some(z => z.row === p.row)) {
                bullets.push({x: p.col * cw + cw * 0.7, row: p.row});
                play("shoot");
            }
        });

        bullets.forEach(b => b.x += 5);
        suns.forEach(s => s.y += 0.5);

        zombies.forEach(z => {
            z.x -= 0.3;
            plants.forEach(p => {
                const px = p.col * cw + cw / 2;
                if (p.row === z.row && Math.abs(z.x - px) < 18) {
                    z.eat = true;
                    p.hp -= 0.05;
                    if (p.hp <= 0) {
                        plants.splice(plants.indexOf(p), 1);
                        play("eat");
                    }
                }
            });
        });

        bullets.forEach((b, i) => {
            zombies.forEach(z => {
                if (z.row === b.row && Math.abs(z.x - b.x) < 12) {
                    z.hp--;
                    bullets.splice(i, 1);
                    if (z.hp <= 0) {
                        play("death");
                    }
                }
            });
        });

        zombies = zombies.filter(z => z.hp > 0);

        if (zombies.some(z => z.x < 0)) {
            over = true;
            result.innerText = "–¢—ã –ø—Ä–æ–∏–≥—Ä–∞–ª!";
            result.style.color = "red";
            play("lose");
        }

        if (spawned >= wave * 4 && zombies.length === 0) {
            if (wave < 3) {
                wave++;
                spawned = 0;
            } else {
                over = true;
                result.innerText = "–¢—ã –≤—ã–∏–≥—Ä–∞–ª!";
                result.style.color = "green";
                play("win");
            }
        }
    }

    function draw() {
        ctx.clearRect(0, 0, c.width, c.height);

        for (let i = 0; i <= rows; i++) {
            ctx.strokeRect(0, i * ch, c.width, 1);
        }
        for (let i = 0; i <= cols; i++) {
            ctx.strokeRect(i * cw, 0, 1, c.height);
        }

        plants.forEach(p => {
            const x = p.col * cw + cw / 2, y = p.row * ch + ch / 2;
            if (p.type === "pea") {
                ctx.fillStyle = "#2f8f2f";
                ctx.beginPath();
                ctx.arc(x, y, 14, 0, 6.28);
                ctx.fill();
            }
            if (p.type === "sun") {
                ctx.fillStyle = "#ffd93b";
                ctx.beginPath();
                ctx.arc(x, y, 20, 0, 6.28);
                ctx.fill();
            }
            if (p.type === "nut") {
                ctx.fillStyle = "#8b5a2b";
                ctx.fillRect(x - 16, y - 16, 32, 32);
            }
        });

        zombies.forEach(z => {
            const y = z.row * ch + ch / 2;
            ctx.fillStyle = "#777";
            ctx.beginPath();
            ctx.arc(z.x, y, 18, 0, 6.28);
            ctx.fill();
            ctx.fillStyle = "white";
            ctx.beginPath();
            ctx.arc(z.x + 5, y - 4, 5, 0, 6.28);
            ctx.fill();
            ctx.fillStyle = "black";
            ctx.beginPath();
            ctx.arc(z.x + 6, y - 4, 2, 0, 6.28);
            ctx.fill();
            ctx.fillStyle = "black";
            ctx.fillRect(z.x - 10, y + 6, 18, 4);

            if (z.type === "cone") {
                ctx.fillStyle = "orange";
                ctx.beginPath();
                ctx.moveTo(z.x - 16, y - 12);
                ctx.lineTo(z.x + 16, y - 12);
                ctx.lineTo(z.x, y - 40);
                ctx.fill();
            }
            if (z.type === "bucket") {
                ctx.fillStyle = "#999";
                ctx.fillRect(z.x - 16, y - 30, 32, 26);
            }
        });

        bullets.forEach(b => {
            ctx.fillStyle = "green";
            ctx.beginPath();
            ctx.arc(b.x, b.row * ch + ch / 2, 4, 0, 6.28);
            ctx.fill();
        });

        suns.forEach(s => {
            ctx.fillStyle = "orange";
            ctx.beginPath();
            ctx.arc(s.x, s.y, 12, 0, 6.28);
            ctx.fill();
        });

        sun.innerText = "–°–æ–ª–Ω—Ü–∞: " + sun;
    }

    (function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
    })();
</script>
</body>
</html>
