<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>üß† Mini PvZ</title>
    <style>
        body {
            background: linear-gradient(#87ceeb, #e6f3e6);
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center
        }

        #game {
            text-align: center;
            margin-top: 10px
        }

        canvas {
            background: #7ec850;
            border: 4px solid #2f6f2f
        }

        button {
            margin: 3px;
            padding: 6px 10px
        }

        #panel {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
<div id="game">
    <div id="panel">
        <button onclick="selectPlant('pea')">üå± –ì–æ—Ä–æ—Ö (50)</button>
        <button onclick="selectPlant('sun')">üåª –ü–æ–¥—Å–æ–ª–Ω—É—Ö (25)</button>
        <button onclick="selectPlant('nut')">ü•ú –û—Ä–µ—Ö (25)</button>
    </div>
    <canvas id="c" width="720" height="360"></canvas>
    <br>
    <div id="sun">–°–æ–ª–Ω—Ü–∞: 100</div>
    <div id="status"></div>
</div>

<script>
    // canvas
    const c = document.getElementById("c"), ctx = c.getContext("2d");
    const rows = 3, cols = 7, cellW = c.width / cols, cellH = c.height / rows;

    // —Ä–µ—Å—É—Ä—Å—ã
    let sun = 100, plants = [], zombies = [], bullets = [], suns = [], lawnmowers = [];
    let selectedPlant = null, tick = 0, wave = 1, spawned = 0, gameOver = false;
    const MAX_WAVES = 3;

    const PLANTS = {
        pea: {
            cost: 50,
            hp: 3,
            shoot: true,
            img: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABhElEQVQ4T5WTT0vDQBSGXx2k1kJAkRMBGJCHGpoRguwC6YQLCThwE2cAluAQLvIF7oBhzxB/Qm0JGBzMqZ3nZ33HnPlpnDl+f48z8eQDzCwBYBpoBvAFmABsAGKADbzxvxd+6r6+4EhDZwA+4GLAtIB7Vd9lkCngAD4AY8AZU1V4AY8AI8CywV+8l8O4Ue1kAMd64HAKlwG4grfI0AAuV1VwAI4EAY0ru43E9c9QAhcAqMYMkoV8BD4AUJgR4CyW+wA5gMHhwf6hnzAc/Mv38C7F4y6L1xHlz0U4Q9FVJbL2u+XkzxwAu4AJgC3AY4Bh4FfAWMx2YfYjT5/iB+4qG+pINiXvT6wXgPZB5HPF1IHoV/8F2bUMd/VEAGvhhYm6Xgyo6Aw9k3i4rGWevhxWj74f4uXw5w+eNCPtU6u4NLLT8V+wg4AAAAASUVORK5CYII="
        },
        sun: {
            cost: 25,
            hp: 3,
            shoot: false,
            produce: true,
            cd: 300,
            img: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABgklEQVQ4T5WTT0sDQRSGv+/IqKQsmAgIlo2EgSx8BkiMiAZSklYQBC0T+g+MhuUOwWLR3EXEGk7AwUiyJEs9ySCEldpNJE3EtrGxE7d17x7eZzB/3ccq2Yj3HuBnjGAkYj0M93Y6nXhGQf5+Z5G2duZk3k8Shm0uAKWZ0VQJWhA1tFskOehBVotN0o3y8zqlQWtrABu8W5c0QF6BoTSyK+gKv7pW1ZzWkVQUQB+iX/1eBqDGJkppcLKn7XJq3/d+oRRKwhQd9cK1qjsQq9rpihNwb6qVajzvJwC2xVtrT7+zwjdz5B7hPn0u+H4z6kntgAd9hs2Nyyj+hZ76iN+DKyvAqZg5Hk2nqF/4Bp1yX4i3jv3AAAAAElFTkSuQmCC"
        },
        nut: {
            cost: 25,
            hp: 22,
            shoot: false,
            img: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABeElEQVQ4T5WTz0tCURiGv+/zGsgkULCQloyFi2uQGawhIQkxZCzqC4nBiNKbYxBBYCAqJbBVEhQhXwAKfBcn+P2keYxW0lCxfDKX7d3R8L/+2t+77lYwQ+M+AMALZcd0D4Aa6WvS+G0fYjAwAuQAGwCzYDWYBpkHedwhJq7x3cA+Ib4CUyyZAG+gJ/AlfhX4Dw1xj8B9X5aPoD+R3G8v+5zp+gMsvsI7QIYg4LrCjgAe7x9DnITuB2Mhi8Ow1hNv1eC7I5FgA02pj1iCh4qDsC+B90mhXSkHhqcM2DGlAlxPLuGNshhgbhCEciymYhFHCsbCuQqFVGnq5i7lwQfG9k4XGKy7bMC2X3Bv28IB+Ab93WnJexWhmZbZ+Ege34BmjN+YDZs6mnVqkNAAAAAElFTkSuQmCC"
        }
    };

    // –∑–æ–º–±–∏
    const ZOMBIES = {
        normal: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABFElEQVQ4T2NkoBAwUqifG9X7/8/7+MQYGBgY/ACkE//8d1o2O/qQ6mg1EKAqLxcPCYj3uGJ/96//P/f8//z88p/1RjFxLMC4t3L9xYGf///Pz//zYGBgYp7I0B5p4YfvvwP1aF/B8I6AAjMzMAwMDQwMAgMSOfq59Zr/XZgZqB1kZGRkYGBgY2D/cO3Y4vT//39/YmNjY8BDxEAz8gU4/f+fzHzf19x+5AXz58Pz/wf+Lz5/fX78/h7x7Dx6/P3z/+/OxoYGRkYxFJgA2DPg8H/7/39+2/+fz5//9/Hz5//r8v5D/gYGBgYGBgYGAY7AAM8b+I3l3+L0AAAAASUVORK5CYII=",
        cone: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABGElEQVQ4T2NkoBAwUqifG9X7/8/7+MQYGBgY/ACkE//8d1o2O/qQ6mg1EKAqLxcPCYj3uGJ/96//P/f8//z88p/1RjFxLMC4t3L9xYGf///Pz//zYGBgYp7I0B5p4YfvvwP1aF/B8I6AAjMzMAwMDQwMAgMSOfq59Zr/XZgZqB1kZGRkYGBgY2D/cO3Y4vT//39/YmNjY8BDxEAz8gU4/f+fzHzf19x+5AXz58Pz/wf+Lz5/fX78/h7x7Dx6/P3z/+/OxoYGRkYxFJgA2DPg8H/7/39+2/+fz5//9/Hz5//r8v5D/gYGBgYGBgYGAY7AAM8b+I3l3+L0AAAAASUVORK5CYII=",
        bucket: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABFElEQVQ4T2NkoBAwUqifG9X7/8/7+MQYGBgY/ACkE//8d1o2O/qQ6mg1EKAqLxcPCYj3uGJ/96//P/f8//z88p/1RjFxLMC4t3L9xYGf///Pz//zYGBgYp7I0B5p4YfvvwP1aF/B8I6AAjMzMAwMDQwMAgMSOfq59Zr/XZgZqB1kZGRkYGBgY2D/cO3Y4vT//39/YmNjY8BDxEAz8gU4/f+fzHzf19x+5AXz58Pz/wf+Lz5/fX78/h7x7Dx6/P3z/+/OxoYGRkYxFJgA2DPg8H/7/39+2/+fz5//9/Hz5//r8v5D/gYGBgYGBgYGAY7AAM8b+I3l3+L0AAAAASUVORK5CYII=",
    };

    // –≥–∞–∑–æ–Ω–æ–∫–æ—Å–∏–ª–∫–∞, –ø—É–ª—è, —Å–æ–ª–Ω—Ü–µ
    const LAWNMOWER_IMG = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAIklEQVQ4T2NkoBAwUqifw3EDgYGBgYGCAbGBoY6MAgAE/wP0MU5ljgAAAABJRU5ErkJggg==";
    const BULLET_IMG = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAOCAYAAAA3A+DjAAAAKElEQVQoz2NkoBAwUqifQwMDAyMjIxMTAwMDAwMjIyMDFw0GJZCUGAAAKxRF0vE3S7AAAAAElFTkSuQmCC";
    const SUN_IMG = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAABTklEQVQ4T2NkoBAwUqifw3EDgYGBgYGCAbGBoY6MAgAE/wP0MU5ljgAAAABJRU5ErkJggg==";

    // –≥–∞–∑–æ–Ω–æ–∫–æ—Å–∏–ª–∫–∏ –ø–æ —Ä—è–¥–∞–º
    for (let r = 0; r < rows; r++) {
        lawnmowers.push({row: r, x: -20, active: true});
    }

    // –≤—ã–±–æ—Ä —Ä–∞—Å—Ç–µ–Ω–∏—è
    function selectPlant(type) {
        selectedPlant = type;
    }

    // –∫–ª–∏–∫
    c.onclick = e => {
        const rect = c.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        // —Å–æ–±–∏—Ä–∞–µ–º —Å–æ–ª–Ω—Ü–µ
        suns.forEach((s, i) => {
            if (Math.hypot(s.x - x, s.y - y) < 15) {
                sun += 25;
                suns.splice(i, 1);
            }
        });
        if (!selectedPlant) return;
        const col = Math.floor(x / cellW), row = Math.floor(y / cellH);
        if (plants.some(p => p.row === row && p.col === col)) return;
        if (sun < PLANTS[selectedPlant].cost) return;
        plants.push({
            row,
            col,
            type: selectedPlant,
            hp: PLANTS[selectedPlant].hp,
            cd: 0,
            scd: PLANTS[selectedPlant].cd
        });
        sun -= PLANTS[selectedPlant].cost;
        selectedPlant = null;
    };

    // –∑–æ–º–±–∏
    function spawnZombie() {
        let ztype = "normal", hp = 9;
        if (wave >= 2) {
            if (Math.random() < 0.5) {
                ztype = "cone";
                hp = 18;
            }
        }
        if (wave >= 3) {
            if (Math.random() < 0.3) {
                ztype = "bucket";
                hp = 30;
            }
        }
        zombies.push({
            row: Math.floor(Math.random() * rows),
            x: c.width - 20,
            hp,
            type: ztype,
            eat: false,
            target: null
        });
        spawned++;
    }

    // —Å–æ–ª–Ω—Ü–µ –ø–∞–¥–∞–µ—Ç
    function spawnSun() {
        suns.push({x: Math.random() * c.width, y: -20});
    }

    // update
    function update() {
        if (gameOver) return;
        tick++;

        // –≤–æ–ª–Ω—ã
        if (tick % 200 === 0 && spawned < wave * 5) {
            spawnZombie();
        }
        if (tick % 300 === 0) {
            spawnSun();
        }

        // —Ä–∞—Å—Ç–µ–Ω–∏—è
        plants.forEach(p => {
            if (p.type === "sun") {
                if (--p.scd <= 0) {
                    suns.push({x: p.col * cellW + cellW / 2, y: p.row * cellH});
                    p.scd = PLANTS.sun.cd;
                }
            }
            if (p.type === "pea" && --p.cd <= 0 && zombies.some(z => z.row === p.row)) {
                bullets.push({x: p.col * cellW + cellW * .7, row: p.row});
                p.cd = 45;
            }
        });

        bullets.forEach(b => b.x += 5);
        suns.forEach(s => s.y += 0.6);

        zombies.forEach(z => {
            if (z.eat && z.target) {
                z.target.hp -= 0.03;
                if (z.target.hp <= 0) {
                    plants.splice(plants.indexOf(z.target), 1);
                    z.eat = false;
                    z.target = null;
                }
            } else {
                z.x -= 0.4;
                plants.forEach(p => {
                    const px = p.col * cellW + cellW / 2;
                    if (p.row === z.row && Math.abs(z.x - px) < 18) {
                        z.eat = true;
                        z.target = p;
                    }
                });
                if (z.x <= 0 && lawnmowers[z.row].active) {
                    zombies = zombies.filter(zz => zz.row !== z.row);
                    lawnmowers[z.row].active = false;
                }
            }
        });

        bullets.forEach((b, i) => zombies.forEach(z => {
            if (z.row === b.row && Math.abs(z.x - b.x) < 14) {
                z.hp--;
                bullets.splice(i, 1);
            }
        }));
        zombies = zombies.filter(z => z.hp > 0);

        if (zombies.some(z => z.x <= 0 && !lawnmowers[z.row].active)) {
            gameOver = true;
            status.innerText = "üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ";
            return;
        }

        if (spawned >= wave * 5 && zombies.length === 0) {
            if (wave < MAX_WAVES) {
                wave++;
                spawned = 0;
            } else {
                gameOver = true;
                status.innerText = "üéâ –ü–æ–±–µ–¥–∞";
            }
        }
    }

    // draw
    function draw() {
        ctx.clearRect(0, 0, c.width, c.height);
        ctx.strokeStyle = "#5fa35f";
        for (let i = 0; i <= rows; i++) {
            ctx.beginPath();
            ctx.moveTo(0, i * cellH);
            ctx.lineTo(c.width, i * cellH);
            ctx.stroke();
        }
        for (let i = 0; i <= cols; i++) {
            ctx.beginPath();
            ctx.moveTo(i * cellW, 0);
            ctx.lineTo(i * cellW, c.height);
            ctx.stroke();
        }

        plants.forEach(p => {
            let img = new Image();
            img.src = PLANTS[p.type].img;
            ctx.drawImage(img, p.col * cellW + 2, p.row * cellH + 2, cellW - 4, cellH - 4);
        });

        zombies.forEach(z => {
            let img = new Image();
            img.src = ZOMBIES[z.type];
            ctx.drawImage(img, z.x - 16, z.row * cellH, 32, cellH);
        });

        bullets.forEach(b => {
            let img = new Image();
            img.src = BULLET_IMG;
            ctx.drawImage(img, b.x - 4, b.row * cellH + cellH / 2 - 4, 8, 8);
        });
        suns.forEach(s => {
            let img = new Image();
            img.src = SUN_IMG;
            ctx.drawImage(img, s.x - 12, s.y - 12, 24, 24);
        });
        lawnmowers.forEach(l => {
            if (l.active) {
                let img = new Image();
                img.src = LAWNMOWER_IMG;
                ctx.drawImage(img, l.x, l.row * cellH, 20, cellH - 2);
            }
        });
        sunDiv.innerText = "–°–æ–ª–Ω—Ü–∞: " + sun;
    }

    // –∑–∞–ø—É—Å–∫
    (function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
    })();
    const sunDiv = document.getElementById("sun"), status = document.getElementById("status");
</script>
</body>
</html>
