<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Mini PvZ</title>

    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: #8b5a2b;
            font-family: Arial;
        }

        #game {
            position: relative;
            width: 720px;
            height: 360px;
            border: 4px solid #2f6f2f;
            overflow: hidden;
        }

        #sky, #grass {
            position: absolute;
            width: 100%;
            height: 50%;
        }

        #sky {
            top: 0;
            background: #87ceeb;
        }

        #grass {
            bottom: 0;
            background: #7ec850;
        }

        canvas {
            display: none;
            background: #7ec850;
        }

        #menu {
            position: absolute;
            top: 50%;
            left: 65%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .tombstone {
            width: 220px;
            height: 260px;
            background: #888;
            border-radius: 50% 50% 0 0;
        }

        #menu button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 10px 20px;
            font-size: 18px;
        }

        #panel {
            display: none;
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 5;
        }

        #sun {
            position: absolute;
            top: 8px;
            right: 8px;
            background: white;
            padding: 4px 8px;
            border-radius: 4px;
        }

        #result {
            position: absolute;
            bottom: 8px;
            width: 100%;
            text-align: center;
            font-size: 26px;
            font-weight: bold;
        }

        button.active {
            background: #ffb703;
        }
    </style>
</head>

<body>
<div id="game">

    <div id="sky"></div>
    <div id="grass"></div>

    <div id="menu">
        <div class="tombstone"></div>
        <button onclick="startGame()">–ò–≥—Ä–∞—Ç—å</button>
    </div>

    <div id="panel">
        <button onclick="selectPlant('pea')">üå± –ì–æ—Ä–æ—Ö (50)</button>
        <button onclick="selectPlant('sun')">üåª –ü–æ–¥—Å–æ–ª–Ω—É—Ö (25)</button>
        <button onclick="selectPlant('nut')">ü•ú –û—Ä–µ—Ö (25)</button>
    </div>

    <canvas id="c" width="720" height="360"></canvas>
    <div id="sun">–°–æ–ª–Ω—Ü–∞: 100</div>
    <div id="result"></div>

</div>

<script>
    const c = document.getElementById("c");
    const ctx = c.getContext("2d");

    const rows = 3, cols = 7;
    const cellW = c.width / cols, cellH = c.height / rows;

    let sun = 100, plants = [], zombies = [], bullets = [], sunsArr = [];
    let selectedPlant = null, gameStarted = false, gameOver = false;
    let tick = 0, wave = 1, spawned = 0;

    // üîä Web Audio (100% —Ä–∞–±–æ—Ç–∞–µ—Ç)
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const sounds = {};

    async function loadSound(name, url) {
        const res = await fetch(url);
        const buf = await res.arrayBuffer();
        sounds[name] = await audioCtx.decodeAudioData(buf);
    }

    function play(name) {
        if (!sounds[name]) return;
        const s = audioCtx.createBufferSource();
        s.buffer = sounds[name];
        s.connect(audioCtx.destination);
        s.start();
    }

    // –ó–ê–ì–†–£–ó–ö–ê –ó–í–£–ö–û–í
    async function loadAllSounds() {
        await loadSound("plant", "https://www.soundjay.com/button/sounds/button-16.mp3");
        await loadSound("spawn", "https://www.soundjay.com/human/sounds/man-groan-01.mp3");
        await loadSound("eat", "https://www.soundjay.com/human/sounds/munch-1.mp3");
        await loadSound("death", "https://www.soundjay.com/human/sounds/scream-01.mp3");
    }

    // –†–ê–°–¢–ï–ù–ò–Ø
    const PLANTS = {
        pea: {cost: 50, hp: 3, cd: 45},
        sun: {cost: 25, hp: 3, cd: 300},
        nut: {cost: 25, hp: 20}
    };

    function selectPlant(t) {
        selectedPlant = t;
    }

    c.onclick = e => {
        if (!gameStarted) return;
        const r = c.getBoundingClientRect();
        const x = e.clientX - r.left;
        const y = e.clientY - r.top;
        const col = Math.floor(x / cellW);
        const row = Math.floor(y / cellH);

        if (!selectedPlant) return;
        if (plants.some(p => p.row === row && p.col === col)) return;
        if (sun < PLANTS[selectedPlant].cost) return;

        plants.push({row, col, type: selectedPlant, hp: PLANTS[selectedPlant].hp, cd: PLANTS[selectedPlant].cd});
        sun -= PLANTS[selectedPlant].cost;
        play("plant");
        selectedPlant = null;
    };

    function spawnZombie() {
        zombies.push({row: Math.floor(Math.random() * rows), x: c.width + 20, hp: 9});
        play("spawn");
        spawned++;
    }

    function update() {
        if (!gameStarted || gameOver) return;
        tick++;

        if (tick % 200 === 0 && spawned < wave * 5) spawnZombie();

        plants.forEach(p => {
            if (p.type === "pea" && --p.cd <= 0 && zombies.some(z => z.row === p.row)) {
                bullets.push({x: p.col * cellW + cellW * 0.7, row: p.row});
                p.cd = PLANTS.pea.cd;
            }
        });

        bullets.forEach(b => b.x += 5);

        zombies.forEach(z => {
            z.x -= 0.4;
            plants.forEach(p => {
                const px = p.col * cellW + cellW / 2;
                if (z.row === p.row && Math.abs(z.x - px) < 16) {
                    p.hp -= 0.03;
                    play("eat");
                    if (p.hp <= 0) plants.splice(plants.indexOf(p), 1);
                }
            });
        });

        bullets.forEach((b, i) => {
            zombies.forEach(z => {
                if (z.row === b.row && Math.abs(z.x - b.x) < 14) {
                    z.hp--;
                    bullets.splice(i, 1);
                    if (z.hp <= 0) play("death");
                }
            });
        });

        zombies = zombies.filter(z => z.hp > 0);

        if (zombies.some(z => z.x < 0)) {
            gameOver = true;
            document.getElementById("result").innerText = "–¢—ã –ø—Ä–æ–∏–≥—Ä–∞–ª!";
            document.getElementById("result").style.color = "red";
        }
    }

    function draw() {
        ctx.fillStyle = "#7ec850";
        ctx.fillRect(0, 0, c.width, c.height);

        ctx.strokeStyle = "rgba(255,255,255,0.25)";
        for (let i = 0; i <= rows; i++) {
            ctx.beginPath();
            ctx.moveTo(0, i * cellH);
            ctx.lineTo(c.width, i * cellH);
            ctx.stroke();
        }
        for (let i = 0; i <= cols; i++) {
            ctx.beginPath();
            ctx.moveTo(i * cellW, 0);
            ctx.lineTo(i * cellW, c.height);
            ctx.stroke();
        }

        plants.forEach(p => {
            const cx = p.col * cellW + cellW / 2, cy = p.row * cellH + cellH / 2;
            ctx.fillStyle = p.type === "pea" ? "#2f8f2f" : p.type === "sun" ? "#ffd93b" : "#8b5a2b";
            ctx.beginPath();
            ctx.arc(cx, cy, 16, 0, Math.PI * 2);
            ctx.fill();
        });

        zombies.forEach(z => {
            const zy = z.row * cellH + cellH / 2;
            ctx.fillStyle = "#777";
            ctx.beginPath();
            ctx.arc(z.x, zy, 18, 0, Math.PI * 2);
            ctx.fill();
        });

        bullets.forEach(b => {
            ctx.fillStyle = "green";
            ctx.beginPath();
            ctx.arc(b.x, b.row * cellH + cellH / 2, 4, 0, Math.PI * 2);
            ctx.fill();
        });

        document.getElementById("sun").innerText = "–°–æ–ª–Ω—Ü–∞: " + sun;
    }

    function startGame() {
        document.getElementById("menu").style.display = "none";
        document.getElementById("panel").style.display = "block";
        document.getElementById("sky").style.display = "none";
        document.getElementById("grass").style.display = "none";
        c.style.display = "block";
        gameStarted = true;
        audioCtx.resume();
        loadAllSounds();
    }

    (function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
    })();
</script>
</body>
</html>
